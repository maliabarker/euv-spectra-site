{% extends 'base.html' %}

{% block title %}{% endblock %}
{% block content %}

    <div class="container">     
        
        <div id="overlay">
            <div class="d-flex justify-content-center">
                <div id="loading"></div>
            </div>
        </div>

        <div class="col-sm-8 offset-sm-2 mt-3"> 
            <div class="row d-flex align-items-center">
                <div class="col-sm-3">
                    <img src="{{url_for('static', filename='imgs/logo-placeholder.png')}}" alt="" class="img-fluid">
                </div>
                <div class="col-sm-9">
                    <h2>Find the Extreme Ultraviolet (EUV) Spectrum for your Star</h2>
                </div>
            </div>
        </div>

        <div class="row mt-2">
            <div class="col-md-6" id="home-left-col">
                <p class="text-center mb-4"><b>Enter Stellar Parameters Manually</b></p>
                <form action="/" method="POST" id="parameter-form">
                    {{ parameter_form.csrf_token }}
                    <fieldset>
                        <div class="form-floating mb-3">
                            {{ parameter_form.teff(class="form-control", placeholder="Teff — Stellar Effective Temperature (K)") }}
                            {{ parameter_form.teff.label(text='* ' + parameter_form.teff.label.text) }}
                        </div>
    
                        <div class="form-floating mb-3">
                            {{ parameter_form.logg(class="form-control", placeholder="log g — Surface Gravity (cm/s2)") }}
                            {{ parameter_form.logg.label(text='* ' + parameter_form.logg.label.text) }}
                        </div>
    
                        <div class="form-floating mb-3">
                            {{ parameter_form.mass(class="form-control", placeholder="M ☉ - Mass in Solar Masses") }}
                            {{ parameter_form.mass.label(text='* ' + parameter_form.mass.label.text) }}
                        </div>
    
                        <div class="form-floating mb-3">
                            {{ parameter_form.stell_rad(class="form-control", placeholder="R ☉ — Stellar Radius in Solar Radian") }}
                            {{ parameter_form.stell_rad.label(text='* ' + parameter_form.stell_rad.label.text) }}
                        </div>
    
                        <div class="row">
                            <div class="col-sm-9">
                                <div class="form-floating mb-3">
                                    {{ parameter_form.dist(class="form-control", placeholder="d — Distance") }}
                                    {{ parameter_form.dist.label(text='* ' + parameter_form.dist.label.text) }}
                                </div>
                            </div>
                            <div class="col-sm-3">
                                <div class="form-floating mb-3">
                                    {{ parameter_form.dist_unit(class="form-select") }}
                                    {{ parameter_form.dist_unit.label(text='* ' + parameter_form.dist_unit.label.text) }}
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            {{ parameter_form.submit(class="btn btn-primary mb-3", for="parameter-form") }}
                        </div>
                    </fieldset>
                </form>
            </div>
            
            <div class="col-md-6">
                <p class="text-center mb-4"><b>Search for Stellar Parameters by Name or Position</b></p>
                <!--—————————NAME FORM——————————-->
                <form action='/' method='POST' id="name-form">
                    <fieldset>
                        {{ name_form.csrf_token }}
                        <div class="form-floating mb-3">
                            {{ name_form.name(class="form-control", placeholder="Star Name") }}
                            {{ name_form.name.label }}
                        </div>
                        <div class="d-flex justify-content-end">
                            {{ name_form.submit(class="btn btn-primary mb-3", for="name-form", onclick="displayLoading();") }}
                        </div>
                    </fieldset>
                </form>

                <p id="home-or" class="my-5"><span>or</span></p>

                <!--—————————POSITION FORM——————————-->
                <form action="/" method="POST" id="position-form">
                    <fieldset>
                        {{ position_form.csrf_token }}
                        <div class="form-floating mb-3">
                            {{ position_form.ra(class="form-control", placeholder="RA") }}
                            {{ position_form.ra.label }}
                        </div>
                        <div class="form-floating mb-3">
                            {{ position_form.dec(class="form-control", placeholder="dec") }}
                            {{ position_form.dec.label }}
                        </div>
                        <div class="d-flex justify-content-end">
                            {{ position_form.submit(class="btn btn-primary mb-3", for="position-form", onclick="displayLoading();") }}
                        </div>
                    </fieldset>
                </form>
            </div>


            {% if show_modal %}
                
                <div class="modal fade" id="myModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="myModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <p class="mt-2 ms-4">
                                    The following catalogs provide data for your target: <b>{{ session.star_name }}</b> <br> 
                                    Choose the data you wish to use below, or enter your own.
                                </p>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">

                                <form id="name-parameters-form" action="/" method="POST" onsubmit="return checkManualInputs()">
                                    <fieldset>
                                        {{ star_name_parameters_form.csrf_token }}
                                        <div class="table-responsive">
                                            <table class="table table-borderless align-bottom" id="star_name_parameter_form_table">
                                                <tr>
                                                    <th><small>{{star_name_parameters_form.catalog_name.label}}</small></th>
                                                    {% for subfield in star_name_parameters_form.catalog_name %}
                                                            <td>
                                                                <p class="my-1">{{ subfield.label }}</p>
                                                                <div class="form-check">
                                                                    {{ subfield(class="form-check-input", type="checkbox", onclick="selectAll(this);") }}
                                                                    <p>Select All</p>
                                                                </div>
                                                            </td>
                                                    {% endfor %}
                                                </tr>

                                                <tr>
                                                    <th><small>{{star_name_parameters_form.teff.label}}</small></th>

                                                    {% for subfield in star_name_parameters_form.teff %}
                                                        
                                                        {% if subfield.id.endswith(last_num) %}
                                                            <td>
                                                                <div class="form-check my-4">
                                                                    {{ subfield(class="form-check-input") }}
                                                                    <!-- <input type="radio" name="teff" value="manual" class="form-check-input"> -->
                                                                    <input type="text" name="manual_teff" id="manual_teff" class="form-control" onclick="checkManualRadio(this)" size="5">
                                                                </div>
                                                            </td>
                                                        {% else %}
                                                            <td>
                                                                <div class="form-check my-4">
                                                                    {{ subfield(class="form-check-input") }}
                                                                    {{ subfield.label(class="form-check-label") }}
                                                                </div>
                                                            </td>
                                                        {% endif %}
                                                    {% endfor %}
                                                    
                                                </tr>

                                                <tr>
                                                    <th><small>{{star_name_parameters_form.logg.label}}</small></th>
                                                    {% for subfield in star_name_parameters_form.logg %}
                                                        {% if subfield.id.endswith(last_num) %}
                                                            <td>
                                                                <div class="form-check my-4">
                                                                    {{ subfield(class="form-check-input") }}
                                                                    <input type="text" name="manual_logg" id="manual_logg" class="form-control" onclick="checkManualRadio(this)" size="5">
                                                                </div>
                                                            </td>
                                                        {% else %}
                                                            <td>
                                                                <div class="form-check my-4">
                                                                    {{ subfield(class="form-check-input") }}
                                                                    {{ subfield.label(class="form-check-label") }}
                                                                </div>
                                                            </td>
                                                        {% endif %}
                                                    {% endfor %}
                                                </tr>

                                                <tr>
                                                    <th><small>{{star_name_parameters_form.mass.label}}</small></th>
                                                    {% for subfield in star_name_parameters_form.mass %}
                                                        {% if subfield.id.endswith(last_num) %}
                                                            <td>
                                                                <div class="form-check my-4">
                                                                    {{ subfield(class="form-check-input") }}
                                                                    <input type="text" name="manual_mass" id="manual_mass" class="form-control" onclick="checkManualRadio(this)" size="5">
                                                                </div>
                                                            </td>
                                                        {% else %}
                                                            <td>
                                                                <div class="form-check my-4">
                                                                    {{ subfield(class="form-check-input") }}
                                                                    {{ subfield.label(class="form-check-label") }}
                                                                </div>
                                                            </td>
                                                        {% endif %}
                                                    {% endfor %}
                                                </tr>

                                                <tr>
                                                    <th><small>{{star_name_parameters_form.stell_rad.label}}</small></th>
                                                    {% for subfield in star_name_parameters_form.stell_rad %}
                                                        {% if subfield.id.endswith(last_num) %}
                                                            <td>
                                                                <div class="form-check my-4">
                                                                    {{ subfield(class="form-check-input") }}
                                                                    <input type="text" name="manual_rad" id="manual_rad" class="form-control" onclick="checkManualRadio(this)" size="5">
                                                                </div>
                                                            </td>
                                                        {% else %}
                                                            <td>
                                                                <div class="form-check my-4">
                                                                    {{ subfield(class="form-check-input") }}
                                                                    {{ subfield.label(class="form-check-label") }}
                                                                </div>
                                                            </td>
                                                        {% endif %}
                                                    {% endfor %}
                                                </tr>

                                                <tr>
                                                    <th><small>{{star_name_parameters_form.dist.label}}</small></th>
                                                    {% for subfield in star_name_parameters_form.dist %}
                                                        {% if subfield.id.endswith(last_num) %}
                                                            <td>
                                                                <div class="form-check my-4">
                                                                    {{ subfield(class="form-check-input") }}
                                                                    <input type="text" name="manual_dist" id="manual_dist" class="form-control" onclick="checkManualRadio(this)" size="5">
                                                                </div>
                                                            </td>
                                                        {% else %}
                                                            <td>
                                                                <div class="form-check my-4">
                                                                    {{ subfield(class="form-check-input") }}
                                                                    {{ subfield.label(class="form-check-label") }}
                                                                </div>  
                                                            </td>    
                                                        {% endif %}
                                                    {% endfor %}
                                                </tr>
                                                
                                            </table>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                            
                                            {{ star_name_parameters_form.submit(class="btn btn-primary", form="name-parameters-form") }}
                                            <!-- <button type="button" class="btn btn-primary">Save changes</button> -->
                                        </div>
                                    </fieldset>
                                </form>

                            </div>
                            
                        </div>
                    </div>
                </div>
                <script>
                    var myModalEl = document.getElementById('myModal');
                    var modal = new bootstrap.Modal(myModalEl);
                    modal.show();
                </script>
            {% endif %}
        </div>

        <div class="text-center mt-2 ">
            <h5>Continue to Fluxes</h5>
            <button class="btn btn-primary">↓</button>
        </div>

        {% if (session.teff and session.logg and session.mass and session.stell_rad and session.dist) %}
            <form id="flux-form" action="/" method="POST">
                <fieldset>
                    {{ flux_form.csrf_token }}
                    <div class="row mt-2">
                        <div class="col-sm-9">
                            <div class="form-floating mb-3">
                                {{ flux_form.fuv(class="form-control", placeholder="FUV — Far Ultraviolet Spectra in Microjanskys (mjy)") }}
                                {{ flux_form.fuv.label }}
                            </div>
                        </div>
                        <div class="col-sm-3">
                            <div class="form-floating mb-3">
                                {{ flux_form.fuv_flag(class="form-select") }}
                                <label for="floatingSelect">Specify</label>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-sm-9">
                            <div class="form-floating mb-3">
                                {{ flux_form.nuv(class="form-control", placeholder="NUV — Near Ultraviolet Spectra in Microjanskys (mjy)") }}
                                {{ flux_form.nuv.label }}
                            </div>
                        </div>
                        <div class="col-sm-3">
                            <div class="form-floating mb-3">
                                {{ flux_form.nuv_flag(class="form-select") }}
                                <label for="floatingSelect">Specify</label>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end">
                        {{ flux_form.submit(class="btn btn-primary mb-3", for="flux-form") }}
                    </div>
                </fieldset>
            </form>
        {% endif %}
    </div>


    
{% endblock %}

{% block script %}
    <script type="text/javascript">
        function showModal() {
            var myModalEl = document.getElementById('myModal');
            var modal = new bootstrap.Modal(myModalEl);
            modal.show();
        };


//—————————————————————————LOADER START————————————————————————
        const loader = document.querySelector("#loading");
        const overlay = document.getElementById("overlay");
        
        // showing loading
        function displayLoading() {
            loader.classList.add("display");
            overlay.style.display = "block";
        }

        // hiding loading
        function hideLoading() {
            loader.classList.remove("display");
            overlay.style.display = "none";
        }
//—————————————————————————LOADER END————————————————————————


//—————————————————————————SELECT ALL START————————————————————————
        function selectAll(obj) {
            console.log(obj.id)

            // get all selectall buttons
            const selectAllBtns = document.querySelectorAll(`[id*="catalog_name"]`);
            console.log(selectAllBtns)
            // check to make sure no other select all buttons are checked
            for (i=0; i < selectAllBtns.length; i++) {
                if ( selectAllBtns[i].id != obj.id ) {
                    selectAllBtns[i].checked = false;
                }
            };

            // get identifying number
            const num = obj.id.match(/(\d+)/)[0];
            // get all radios w identifying number
            const btns = document.getElementById('star_name_parameter_form_table').querySelectorAll(`[id*="${num}"]`);
            // check radio btns
            for( i = 0 ; i < btns.length ; i++ ) {
                btns[i].checked = true;
            };
        };
//—————————————————————————SELECT ALL END————————————————————————


        function checkManualRadio(obj) {
            obj.previousElementSibling.checked = true;
        };

        function checkManualInputs(){
            // check all radio buttons and if a manual radio button is clicked assign the value to 
            const manualBtns = document.querySelectorAll(`[id*="{{ last_num }}"]`);
            for(i = 0; i < manualBtns.length; i++){
                if (manualBtns[i].checked) {
                    const newVal = manualBtns[i].nextElementSibling.value
                    manualBtns[i].value = newVal
                };
            };
            return true; // submit the form
        };

    </script>
{% endblock %}