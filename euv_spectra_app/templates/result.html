{% extends 'base.html' %}
{% set active_page = "none" %}
{% block title %}Results{% endblock %}
{% block content %}
    {% include 'partials/loading_screen.html' %}

    <div>
        <img src="{{ url_for('static', filename='imgs/search_bar_bg.png') }}" alt="" class="full-width img img-fluid" id="about-hero-img">
        
        <div class="row pt-5">
            <div class="col-md-2 offset-md-1 pt-4">
                <h5 style="color: white;">Start a New Search</h5>
            </div>
            <div class="col-md-7">
                {% include 'partials/search_bar.html' %}
            </div>
        </div>
    </div>

    <h4 class="mt-5 pt-4 text-center">Closest Match PHOENIX Model
        {% if stellar_obj.position is not none %}
            for <i>{{ stellar_obj.position }}</i>
        {% elif stellar_obj.star_name is not none %}
            for <i>{{ stellar_obj.star_name }}</i>
        {% endif %}
    </h4>
    
    <div class="row mt-4">
        <div class="col-md-10 offset-md-1 text-center table-responsive">
            <table class="table table-striped align-middle">
                <thead>
                    <tr>
                        <th scope="col">Stellar Parameter</th>
                        <th scope="col">Your Target's Parameters</th>
                        {% for model in matching_models %}
                            {% if loop.index == 1 %}
                                <th scope="col">Model {{ loop.index }} (Best Match) Parameters</th>
                            {% else %}
                                <th scope="col">Model {{ loop.index }} Parameters</th>
                            {% endif %}
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <th scope="row">T<sub>eff</sub> <small>(K)</small></th>
                        <td>{{ stellar_obj.teff }}</td>
                        {% for model in matching_models %}
                            <td>{{ model.teff }}</td>
                        {% endfor %}
                    </tr>
                    <tr>
                        <th scope="row">log(g) <small>(cm/s<sup>2</sup>)</small></th>
                        <td>{{ stellar_obj.logg }}</td>
                        {% for model in matching_models %}
                            <td>{{ model.logg }}</td>
                        {% endfor %}
                    </tr>
                    <tr>
                        <th scope="row">Mass <small>(M<sub>sun</sub>)</small></th>
                        <td>{{ stellar_obj.mass }}</td>
                        {% for model in matching_models %}
                            <td>{{ model.mass }}</td>
                        {% endfor %}
                    </tr>
                    <tr>
                        <th scope="row">GALEX FUV Flux Density<sup>*</sup></th>
                        {% if stellar_obj.fluxes.fuv_is_saturated == True %}
                            <td>{{ "%.2f"|format(stellar_obj.fluxes.processed_fuv_saturated) }}</td>
                        {% elif stellar_obj.fluxes.fuv_is_upper_limit == True %}
                            <td>{{ "%.2f"|format(stellar_obj.fluxes.processed_fuv_upper_limit) }}</td>
                        {% elif stellar_obj.fluxes.processed_fuv is defined and stellar_obj.fluxes.processed_fuv_err is defined %}
                            <td>{{ "%.2f"|format(stellar_obj.fluxes.processed_fuv) }} +/- {{ "%.2f"|format(stellar_obj.fluxes.processed_fuv_err) }}</td>
                        {% elif stellar_obj.fluxes.processed_fuv is defined %}
                            <td>{{ "%.2f"|format(stellar_obj.fluxes.processed_fuv) }}</td>
                        {% endif %}
                        {% for model in matching_models %}
                            <td>{{ "%.2f"|format(model.fuv) }}</td>
                        {% endfor %}
                    </tr>
                    <tr>
                        <th scope="row">GALEX NUV Flux Density<sup>*</sup></th>
                        {% if stellar_obj.fluxes.nuv_is_saturated == True %}
                            <td>{{ "%.2f"|format(stellar_obj.fluxes.processed_nuv_saturated) }}</td>
                        {% elif stellar_obj.fluxes.nuv_is_upper_limit == True %}
                            <td>{{ "%.2f"|format(stellar_obj.fluxes.processed_nuv_upper_limit) }}</td>
                        {% elif stellar_obj.fluxes.processed_nuv is defined and stellar_obj.fluxes.processed_nuv_err is defined %}
                            <td>{{ "%.2f"|format(stellar_obj.fluxes.processed_nuv) }} +/- {{ "%.2f"|format(stellar_obj.fluxes.processed_nuv_err) }}</td>
                        {% elif stellar_obj.fluxes.processed_nuv is defined %}
                            <td>{{ "%.2f"|format(stellar_obj.fluxes.processed_nuv) }}</td>
                        {% endif %}
                        {% for model in matching_models %}
                            <td>{{ "%.2f"|format(model.nuv) }}</td>
                        {% endfor %}
                    </tr>
                    <tr>
                        <th scope="row">PHOENIX EUV Flux Density<sup>*</sup><br><small>(from 100 - 1000 Å)</small></th>
                        <td>N/A</td>
                        {% for model in matching_models %}
                            <td>{{ "%.2f"|format(model.euv) }}</td>
                        {% endfor %}
                    </tr>
                    <tr>
                        <th scope="col">Download FITS File<sup>**</sup></th>
                        <td>N/A</td>
                        {% for model in matching_models %}
                            <td>
                                <button class="btn btn-primary mb-2 small" id="flux-continue-btn" onclick="checkDirectory('{{ model.fits_filename }}', 'Model {{ loop.index }}')">
                                    <i class="fa-solid fa-file-arrow-down"></i>
                                    <small>Download Spectrum {{ loop.index }}</small>
                                </button>
                                <div id="{{ model.fits_filename }}-errorbox" style="color: tomato;"></div>
                            </td>
                            {# <!-- <td>
                                <button class="btn btn-primary mb-2 small" id="flux-continue-btn" onclick="checkDirectory('{{ test_filepaths[loop.index] }}', 'Model {{ loop.index }}')">
                                    <i class="fa-solid fa-file-arrow-down"></i>
                                    <small>Download Spectrum {{ loop.index }} TEST</small>
                                    <small>{{ test_filepaths[loop.index] }}</small>
                                </button>
                                <div id="{{ test_filepaths[loop.index] }}-errorbox" style="color: tomato;"></div>
                            </td> --> #}
                        {% endfor %}
                    </tr>
                </tbody>
            </table>              
        </div>
    </div>

    <div class="text-center mt-3">
        <a data-bs-toggle="modal" data-bs-target="#myModal" class="btn btn-primary py-3 px-2">Click Here to Edit Your Parameters</a>
    </div>
    <div class="chart" id="linegraph">
        <script>
            var graphs = JSON.parse('{{graphJSON | safe}}');
            var config = {responsive: true};
            Plotly.plot('linegraph', graphs, config);
        </script>
    </div>
    <div class="my-3">
        <small>
            NOTES: <br> 
            * In units of ergs/s/cm<sup>2</sup>/Å, scaled to stellar surface and corrected for photospheric contribution. <br>
            ** See More Info About FITS Products <a href="/about">Here</a> <br>
            *** If a GALEX flux is saturated, models are searched with corresponding flux values greater than or equal to the GALEX saturated flux value. <br>
            **** If a GALEX flux is an upper limit, models are searched with corresponding flux values less than or equal to the GALEX upper limit flux value.
        </small>
    </div>
    {% include 'partials/modal.html' %}
{% endblock %}

{% block script %}
    <script>
        $(".alert").fadeTo(5000, 500).fadeOut(500, function(){
            $(".alert").fadeOut(500);
        });
    </script>
    <script src="{{ url_for('static', filename='js/download.js' )}}"></script>
{% endblock %}